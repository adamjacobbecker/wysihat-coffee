var WysiHat;WysiHat={},$.fn.wysihat=function(){return this.each(function(){return $(this).data("wysihat",new WysiHat.Editor($(this)))})};var DOMUtils;window.getSelection||(DOMUtils={isDataNode:function(e){try{return e&&e.nodeValue!==null&&e.data!==null}catch(t){return!1}},isAncestorOf:function(e,t){return e?!DOMUtils.isDataNode(e)&&(e.contains(DOMUtils.isDataNode(t)?t.parentNode:t)||t.parentNode===e):!1},isAncestorOrSelf:function(e,t){return DOMUtils.isAncestorOf(e,t)||e===t},findClosestAncestor:function(e,t){if(DOMUtils.isAncestorOf(e,t))while(t&&t.parentNode!==e)t=t.parentNode;return t},getNodeLength:function(e){return DOMUtils.isDataNode(e)?e.length:e.childNodes.length},splitDataNode:function(e,t){var n;return DOMUtils.isDataNode(e)?(n=e.cloneNode(!1),e.deleteData(t,e.length),n.deleteData(0,t),e.parentNode.insertBefore(n,e.nextSibling)):!1}},window.Range=function(){var e,t,n;return e=function(e){return this._document=e,this.startContainer=this.endContainer=e.body,this.endOffset=DOMUtils.getNodeLength(e.body)},n=function(e){var t;t=0;while(e=e.previousSibling)continue;return t},t=function(e){var t;this.range=e;if(e.collapsed)return;return t=e.commonAncestorContainer,this._next=e.startContainer===t&&!DOMUtils.isDataNode(e.startContainer)?e.startContainer.childNodes[e.startOffset]:DOMUtils.findClosestAncestor(t,e.startContainer),this._end=e.endContainer===t&&!DOMUtils.isDataNode(e.endContainer)?e.endContainer.childNodes[e.endOffset]:DOMUtils.findClosestAncestor(t,e.endContainer).nextSibling},e.START_TO_START=0,e.START_TO_END=1,e.END_TO_END=2,e.END_TO_START=3,e.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_toTextRange:function(){var e,t;return e=function(e,t,n){var r,i,s,o,u,a,f;s=t[n?"startContainer":"endContainer"],a=t[n?"startOffset":"endOffset"],f=0,r=DOMUtils.isDataNode(s)?s:s.childNodes[a],i=DOMUtils.isDataNode(s)?s.parentNode:s;if(s.nodeType===3||s.nodeType===4)f=a;return u=t._document.createElement("a"),r?i.insertBefore(u,r):i.appendChild(u),o=t._document.body.createTextRange(),o.moveToElementText(u),u.parentNode.removeChild(u),e.setEndPoint(n?"StartToStart":"EndToStart",o),e[n?"moveStart":"moveEnd"]("character",f)},t=this._document.body.createTextRange(),e(t,this,!0),e(t,this,!1),t},_refreshProperties:function(){var e;this.collapsed=this.startContainer===this.endContainer&&this.startOffset===this.endOffset,e=this.startContainer;while(e&&e!==this.endContainer&&!DOMUtils.isAncestorOf(e,this.endContainer))e=e.parentNode;return this.commonAncestorContainer=e},setStart:function(e,t){return this.startContainer=e,this.startOffset=t,this._refreshProperties()},setEnd:function(e,t){return this.endContainer=e,this.endOffset=t,this._refreshProperties()},setStartBefore:function(e){return this.setStart(e.parentNode,n(e))},setStartAfter:function(e){return this.setStart(e.parentNode,n(e)+1)},setEndBefore:function(e){return this.setEnd(e.parentNode,n(e))},setEndAfter:function(e){return this.setEnd(e.parentNode,n(e)+1)},selectNode:function(e){return this.setStartBefore(e),this.setEndAfter(e)},selectNodeContents:function(e){return this.setStart(e,0),this.setEnd(e,DOMUtils.getNodeLength(e))},collapse:function(e){return e?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){var e;return(e=function(t){var n,r;r=void 0,n=document.createDocumentFragment();while(r=t.next())r=r.cloneNode(!t.hasPartialSubtree()),t.hasPartialSubtree()&&r.appendChild(e(t.getSubtreeIterator())),n.appendChild(r);return n})(new t(this))},extractContents:function(){var e,n;return n=this.cloneRange(),this.startContainer!==this.commonAncestorContainer&&this.setStartAfter(DOMUtils.findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),(e=function(t){var n,r;r=void 0,n=document.createDocumentFragment();while(r=t.next())t.hasPartialSubtree()?r=r.cloneNode(!1):t.remove(),t.hasPartialSubtree()&&r.appendChild(e(t.getSubtreeIterator())),n.appendChild(r);return n})(new t(n))},deleteContents:function(){var e,n;return n=this.cloneRange(),this.startContainer!==this.commonAncestorContainer&&this.setStartAfter(DOMUtils.findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),(e=function(t){var n;n=[];while(t.next())n.push(t.hasPartialSubtree()?e(t.getSubtreeIterator()):t.remove());return n})(new t(n))},insertNode:function(e){var t;return DOMUtils.isDataNode(this.startContainer)?(DOMUtils.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(e,this.startContainer.nextSibling)):(t=this.startContainer.childNodes[this.startOffset],t?this.startContainer.insertBefore(e,t):this.startContainer.appendChild(e)),this.setStart(this.startContainer,this.startOffset)},surroundContents:function(e){var t;return t=this.extractContents(),this.insertNode(e),e.appendChild(t),this.selectNode(e)},compareBoundaryPoints:function(t,n){var r,i,s,o;r=void 0,s=void 0,i=void 0,o=void 0;switch(t){case e.START_TO_START:case e.START_TO_END:r=this.startContainer,s=this.startOffset;break;case e.END_TO_END:case e.END_TO_START:r=this.endContainer,s=this.endOffset}switch(t){case e.START_TO_START:case e.END_TO_START:i=n.startContainer,o=n.startOffset;break;case e.START_TO_END:case e.END_TO_END:i=n.endContainer,o=n.endOffset}return r.sourceIndex<i.sourceIndex?-1:r.sourceIndex===i.sourceIndex?s<o?-1:s===o?0:1:1},cloneRange:function(){var t;return t=new e(this._document),t.setStart(this.startContainer,this.startOffset),t.setEnd(this.endContainer,this.endOffset),t},detach:function(){},toString:function(){return this._toTextRange().text},createContextualFragment:function(e){var t,n;t=(DOMUtils.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1),t.innerHTML=e,n=this._document.createDocumentFragment();while(t.firstChild)n.appendChild(t.firstChild);return n}},t.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return!!this._next},next:function(){var e;return e=this._current=this._next,this._next=this._current&&this._current.nextSibling!==this._end?this._current.nextSibling:null,DOMUtils.isDataNode(this._current)&&(this.range.endContainer===this._current&&(e=e.cloneNode(!0)).deleteData(this.range.endOffset,e.length-this.range.endOffset),this.range.startContainer===this._current&&(e=e.cloneNode(!0)).deleteData(0,this.range.startOffset)),e},remove:function(){var e,t;return!DOMUtils.isDataNode(this._current)||this.range.startContainer!==this._current&&this.range.endContainer!==this._current?this._current.parentNode.removeChild(this._current):(t=this.range.startContainer===this._current?this.range.startOffset:0,e=this.range.endContainer===this._current?this.range.endOffset:this._current.length,this._current.deleteData(t,e-t))},hasPartialSubtree:function(){return!DOMUtils.isDataNode(this._current)&&(DOMUtils.isAncestorOrSelf(this._current,this.range.startContainer)||DOMUtils.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var n;return n=new e(this.range._document),n.selectNodeContents(this._current),DOMUtils.isAncestorOrSelf(this._current,this.range.startContainer)&&n.setStart(this.range.startContainer,this.range.startOffset),DOMUtils.isAncestorOrSelf(this._current,this.range.endContainer)&&n.setEnd(this.range.endContainer,this.range.endOffset),new t(n)}},e}(),window.Range._fromTextRange=function(e,t){var n,r;return n=function(e,n,r){var i,s,o;s=t.createElement("a"),i=n.duplicate(),i.collapse(r),o=i.parentElement();for(;;){o.insertBefore(s,s.previousSibling),i.moveToElementText(s);if(!(i.compareEndPoints(r?"StartToStart":"StartToEnd",n)>0&&s.previousSibling))break}return i.compareEndPoints(r?"StartToStart":"StartToEnd",n)===-1&&s.nextSibling?(i.setEndPoint(r?"EndToStart":"EndToEnd",n),e[r?"setStart":"setEnd"](s.nextSibling,i.text.length)):e[r?"setStartBefore":"setEndBefore"](s),s.parentNode.removeChild(s)},r=new Range(t),n(r,e,!0),n(r,e,!1),r},document.createRange=function(){return new Range(document)},window.Selection=function(){var e;return e=function(e){var t;return this._document=e,t=this,e.attachEvent("onselectionchange",function(){return t._selectionChangeHandler()})},e.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){return this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(e){return e.compareEndPoints("StartToEnd",e)!==0||e.parentElement().isContentEditable},addRange:function(e){var t,n;return t=this._document.selection.createRange(),n=e._toTextRange(),this._selectionExists(t)?(n.compareEndPoints("StartToStart",t)===-1&&(n.compareEndPoints("StartToEnd",t)>-1&&n.compareEndPoints("EndToEnd",t)===-1?t.setEndPoint("StartToStart",n):n.compareEndPoints("EndToStart",t)<1&&n.compareEndPoints("EndToEnd",t)>-1&&t.setEndPoint("EndToEnd",n)),t.select()):n.select()},removeAllRanges:function(){return this._document.selection.empty()},getRangeAt:function(e){var t;return t=this._document.selection.createRange(),this._selectionExists(t)?Range._fromTextRange(t,this._document):null},toString:function(){return this._document.selection.createRange().text}},e}(),window.getSelection=function(){var e;return e=new Selection(document),function(){return e}}()),jQuery.extend(Range.prototype,function(){var e,t,n,r,i;return t=function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)===-1&&this.compareBoundaryPoints(this.START_TO_END,e)===-1&&this.compareBoundaryPoints(this.END_TO_END,e)===-1&&this.compareBoundaryPoints(this.END_TO_START,e)===-1},e=function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)===1&&this.compareBoundaryPoints(this.START_TO_END,e)===1&&this.compareBoundaryPoints(this.END_TO_END,e)===1&&this.compareBoundaryPoints(this.END_TO_START,e)===1},n=function(e){return!e||!e.compareBoundaryPoints?!1:!this.beforeRange(e)&&!this.afterRange(e)},r=function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)===0&&this.compareBoundaryPoints(this.START_TO_END,e)===1&&this.compareBoundaryPoints(this.END_TO_END,e)===0&&this.compareBoundaryPoints(this.END_TO_START,e)===-1},i=function(){var e,t,n;t=this.commonAncestorContainer;while(t.nodeType===Node.TEXT_NODE)t=t.parentNode;return e=void 0,n=this,$.each(t.children,function(e,t){var r;return r=document.createRange(),r.selectNodeContents(t),t=n.betweenRange(r)}),$(e||t)},{beforeRange:t,afterRange:e,betweenRange:n,equalRange:r,getNode:i}}());var Selection;jQuery.browser.msie&&jQuery.browser.version<9?jQuery.extend(Selection.prototype,function(){var e,t;return e=function(){var e;return e=this._document.selection.createRange(),jQuery(e.parentElement())},t=function(e){var t;return t=this._document.body.createTextRange(),t.moveToElementText(e),t.select()},{getNode:e,selectNode:t}}()):(typeof Selection=="undefined"&&(Selection={},Selection.prototype=window.getSelection().__proto__),jQuery.extend(Selection.prototype,function(){var e,t;return e=function(){return this.rangeCount>0?this.getRangeAt(0).getNode():null},t=function(e){var t;return t=document.createRange(),t.selectNode(e[0]),this.removeAllRanges(),this.addRange(t)},{getNode:e,selectNode:t}}())),jQuery.browser.msie?jQuery.extend(Selection.prototype,function(){var e,t;return t=function(){var e,t,n;return e=jQuery("#bookmark"),e&&e.remove(),e=jQuery('<span id="bookmark">&nbsp;</span>'),t=jQuery("<div></div>").html(e),n=this._document.selection.createRange(),n.collapse(),n.pasteHTML(t.html())},e=function(){var e,t;e=jQuery("#bookmark");if(!e)return;return t=this._document.selection.createRange(),t.moveToElementText(e),t.collapse(),t.select(),e.remove()},{setBookmark:t,moveToBookmark:e}}()):jQuery.extend(Selection.prototype,function(){var e,t;return t=function(){var e;return e=jQuery("#bookmark"),e&&e.remove(),e=jQuery('<span id="bookmark">&nbsp;</span>'),this.getRangeAt(0).insertNode(e)},e=function(){var e,t;e=jQuery("#bookmark");if(!e)return;return t=document.createRange(),t.setStartBefore(e),this.removeAllRanges(),this.addRange(t),e.remove()},{setBookmark:t,moveToBookmark:e}}()),WysiHat.Editor=function(){function e(e){var t=this;this.$el=$('<div id="'+e.attr("id")+"_editor"+'" class="editor" contentEditable="true"></div>'),this.$el.html(WysiHat.Formatting.getBrowserMarkupFrom(e.val())),e.before(this.$el),e.hide(),e.closest("form").submit(function(n){return n.preventDefault(),console.log(WysiHat.Formatting.getApplicationMarkupFrom(t.$el)),e.val(WysiHat.Formatting.getApplicationMarkupFrom(t.$el))}),this.toolbar=new WysiHat.Toolbar(this),$.extend(this.$el,{commands:WysiHat.Commands,states:WysiHat.States,execCommand:WysiHat.ExecCommand})}return e}(),WysiHat.StyleSelectors={fontname:"fontFamily",fontsize:"fontSize",forecolor:"color",hilitecolor:"backgroundColor",backcolor:"backgroundColor"},WysiHat.BrowserFeatures=function(){var e,t,n,r,i;return e=function(e){var t,n;return t=void 0,n=void 0,t=$("<iframe></iframe>"),t.css({position:"absolute",left:"-1000px"}),t.onFrameLoaded(function(){return typeof t.contentDocument!="undefined"?n=t.contentDocument:typeof t.contentWindow!="undefined"&&typeof t.contentWindow.document!="undefined"&&(n=t.contentWindow.document),n.designMode="on",e(n),t.remove()}),$(document.body).insert(t)},n=function(e){var t,n;return e.body.innerHTML="",e.execCommand("insertparagraph",!1,null),n=void 0,t=e.body.childNodes[0],t&&t.tagName&&(n=t.tagName.toLowerCase()),n==="div"?r.paragraphType="div":e.body.innerHTML==="<p><br></p>"?r.paragraphType="br":r.paragraphType="p"},t=function(e){var t,n;return e.body.innerHTML="tab",e.execCommand("indent",!1,null),n=void 0,t=e.body.childNodes[0],t&&t.tagName&&(n=t.tagName.toLowerCase()),r.indentInsertsBlockquote=n==="blockquote"},r={},r.run=i=function(){if(r.finished)return;return e(function(e){return n(e),t(e),r.finished=!0})},r}(),WysiHat.ExecCommand=function(e,t,n){try{window.document.execCommand(e,t,n)}catch(r){return null}return $(document.activeElement).trigger("field:change")},WysiHat.Commands={bold:function(){return this.execCommand("bold",!1,null)},underline:function(){return this.execCommand("underline",!1,null)},italic:function(){return this.execCommand("italic",!1,null)},strikethrough:function(){return this.execCommand("strikethrough",!1,null)},indent:function(){var e,t,n,r;return $.browser.mozilla?(r=void 0,n=void 0,t=void 0,e=void 0,r=window.getSelection(),n=r.getRangeAt(0),t=r.getNode(),n.collapsed&&(n=document.createRange(),n.selectNodeContents(t),r.removeAllRanges(),r.addRange(n)),e=$("<blockquote></blockquote>"),n=r.getRangeAt(0),n.surroundContents(e)):this.execCommand("indent",!1,null)},outdent:function(){return this.execCommand("outdent",!1,null)},toggleIndentation:function(){return this.indentSelected()?this.outdentSelection():this.indentSelection()},fontSize:function(e){return this.execCommand("fontsize",!1,e)},color:function(e){return this.execCommand("forecolor",!1,e)},backgroundColor:function(e){return $.browser.mozilla?this.execCommand("hilitecolor",!1,e):this.execCommand("backcolor",!1,e)},align:function(e){return this.execCommand("justify"+e)},link:function(e){return this.execCommand("createLink",!1,e)},unlink:function(){var e;return e=window.getSelection().getNode(),this.linkSelected()&&window.getSelection().selectNode(e),this.execCommand("unlink",!1,null)},formatblock:function(e){return this.execCommand("formatblock",!1,e)},orderedList:function(){var e,t;return t=void 0,e=void 0,t=window.getSelection(),e=t.getNode(),this.states.orderedList()&&!e.is("ol li:last-child, ol li:last-child *")?t.selectNode(e.closest("ol")):this.states.unorderedList()&&t.selectNode(e.closest("ul")),this.execCommand("insertorderedlist",!1,null)},unorderedList:function(){var e,t;return t=void 0,e=void 0,t=window.getSelection(),e=t.getNode(),this.states.unorderedList()&&!e.is("ul li:last-child, ul li:last-child *")?t.selectNode(e.closest("ul")):this.states.orderedList()&&t.selectNode(e.closest("ol")),this.execCommand("insertunorderedlist",!1,null)},insertImage:function(e){return this.execCommand("insertImage",!1,e)},insertHTML:function(e){var t;return $.browser.msie?(t=window.document.selection.createRange(),t.pasteHTML(e),t.collapse(!1),t.select()):this.execCommand("insertHTML",!1,e)},getSelectedStyles:function(){var e,t;return t={},e=this,WysiHat.StyleSelectors.each(function(n){var r;return r=e.selection.getNode(),t[n.first()]=$(r).css(n.last())}),t}},WysiHat.States={queryCommandState:function(e){var t;t=this.states[""+e];if(t)return t();try{return window.document.queryCommandState(e)}catch(n){return null}},indented:function(){var e;return e=window.getSelection().getNode(),e.is("blockquote, blockquote *")},aligned:function(){var e;return e=window.getSelection().getNode(),$(e).css("textAlign")},linked:function(){var e;return e=window.getSelection().getNode(),e?e.get(0).tagName.toUpperCase()==="A":!1},orderedList:function(){var e;return e=window.getSelection().getNode(),e?e.is('*[contenteditable=""] ol, *[contenteditable=true] ol, *[contenteditable=""] ol *, *[contenteditable=true] ol *'):!1},unorderedList:function(){var e;return e=window.getSelection().getNode(),e?e.is('*[contenteditable=""] ul, *[contenteditable=true] ul, *[contenteditable=""] ul *, *[contenteditable=true] ul *'):!1}},function(){var e,t,n;return e=function(e,t){var n,r,i,s;i=t.length,r=void 0,s=$("<"+e.tagName.toLowerCase()+"></"+e.tagName.toLowerCase()+">"),e=$(e),r=0;while(r<t.length)n=t[r],e.attr(n)&&s.attr(n,e.attr(n)),r++;return s},n=function(e,t){var n,r,i,s;i=$(e).children,r=i.length,n=void 0,n=0,s=[];while(n<r)t(i[n]),s.push(n++);return s},t=function(r,i,s,o){var u,a,f;a=r.parentNode;switch(r.nodeType){case Node.ELEMENT_NODE:f=r.tagName.toLowerCase();if(o)return u=r.cloneNode(!1),n(r,function(e){return u.appendChild(e),t(e,i,s,o)}),a.insertBefore(u,r);if(f in s)return u=e(r,s[f]),n(r,function(e){return u.appendChild(e),t(e,i,s,o)}),a.insertBefore(u,r);if(!(f in i))return n(r,function(e){return a.insertBefore(e,r),t(e,i,s,o)});break;case Node.COMMENT_NODE:return a.removeChild(r)}},jQuery.fn.sanitizeContents=function(e){var r,i,s,o;return r=$(this),s={},$.each((e.remove||"").split(","),function(e){return s[$.trim(e)]=!0}),i={},$.each((e.allow||"").split(","),function(e){var t,n,r;return n=$.trim(e).split(/[\[\]]/),r=n[0],t=$.grep(n.slice(1),function(e,t){return/./.test(e)}),i[r]=t}),o=e.skip,n(r,function(e){return t(e,s,i,o)}),r}}(),$(document).ready(function(){var e;return e=function(e,t){var n,r;n=$(t),t=n.get(0),r=void 0,n.attr("contentEditable")==="true"&&(r=n.html()),r=n.val();if(r&&t.previousValue!==r)return n.trigger("field:change"),t.previousValue=r},$('input,textarea,*[contenteditable=""],*[contenteditable=true]').keyup(e)}),function(){var e,t,n;return n=function(e,t){var n;return n=function(){return e.readyState==="complete"?($(e).unbind("readystatechange",n),t(),!0):!1},$(e).bind("readystatechange",n),n()},e=function(e){var t,r,i,s;return i=function(){var t;if(t)return;return t=!0,r&&r.stop(),e.trigger("frame:loaded")},e=$(e),t=e.get(0),s=void 0,r=void 0,s=!1,window.addEventListener&&(r=$(document).bind("DOMFrameContentLoaded",function(t){if(e===$(this))return i()})),e.load(function(){var t;return t=void 0,typeof e.contentDocument!="undefined"?t=e.contentDocument:typeof e.contentWindow!="undefined"&&typeof e.contentWindow.document!="undefined"&&(t=e.contentWindow.document),n(t,i)}),e},t=function(e,t){return e.bind("frame:loaded",t),e.observeFrameContentLoaded()},jQuery.fn.observeFrameContentLoaded=e,jQuery.fn.onFrameLoaded=t}(),$(document).ready(function(){var e,t,n;return e=$(document),"selection"in document&&"onselectionchange"in document?(n=function(){var e,t;return t=document.selection.createRange(),e=t.parentElement(),$(e).trigger("selection:change")},e.bind("selectionchange",n)):(t=void 0,n=function(){var e,n,r,i;e=document.activeElement,n=e.tagName.toLowerCase();if(n==="textarea"||n==="input")return t=null,$(e).trigger("selection:change");i=window.getSelection();if(i.rangeCount<1)return;r=i.getRangeAt(0);if(r&&r.equalRange(t))return;t=r,e=r.commonAncestorContainer;while(e.nodeType===Node.TEXT_NODE)e=e.parentNode;return $(e).trigger("selection:change")},e.mouseup(n),e.keyup(n))}),WysiHat.Formatting=function(){var e,t,n;return e={},n={},t={},{getBrowserMarkupFrom:function(e){var t,n,r,i,s;return s=function(e,t){return $(e).replaceWith('<span style="'+t+'">'+e.innerHTML+"</span>")},i=function(){return t.find("strong").each(function(e,t){return s(t,"font-weight: bold")})},r=function(){return t.find("em").each(function(e,t){return s(t,"font-style: italic")})},n=function(){return t.find("div").each(function(e,t){return $(t).replaceWith("<p>"+t.innerHTML+"</p>")})},t=$("<div>"+e+"</div>"),$.browser.webkit||$.browser.mozilla?(i(),r()):($.browser.msie||$.browser.opera)&&n(),t.html()},getApplicationMarkupFrom:function(r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C;return f=r.get(0),E=e,N=void 0,u=void 0,b=void 0,w=void 0,x=void 0,C=function(e){var t,n,r,i,s;n=e.length,r=void 0,i=void 0,t=void 0,t=0,s=[];while(t<n)r=e[t],r.nodeType===1?(i=r.tagName.toLowerCase(),S(i,r),C(r.childNodes),o(i)):r.nodeType===3&&T(r.nodeValue),s.push(t++);return s},S=function(r,o){if(E===e)if(p(r)){d(o)&&i($("<br />").get(0)),l();if(g(r))return u=h(r),E=n}else{if(!v(r))return s(r,o);v(c())&&(x.parentNode.removeChild(x),l()),i(o.cloneNode(!1));if(!x.previousNode)return l()}else if(E===n){if(y(r))return E=t}else if(E===t){if(v(r))return i(o.cloneNode(!1));if(!p(r))return s(r,o)}},o=function(r){if(E===e){m(r)&&l();if(b!==w)return w=w.parentNode}else if(E===n){if(g(r))return u=N,E=e}else if(E===t){y(r)&&(l(),E=n);if(b!==w)return w=w.parentNode}},p=function(e){return m(e)||g(e)},m=function(e){return e==="p"||e==="div"},g=function(e){return e==="ol"||e==="ul"},y=function(e){return e==="li"},v=function(e){return e==="br"},d=function(e){return e.tagName.toLowerCase()==="p"&&e.childNodes.length===0},T=function(e){return i(document.createTextNode(e))},s=function(e,t){return f=t.cloneNode(!1),e==="span"&&($(t).css("fontWeight")==="bold"?f=$("<strong></strong>").get(0):$(t).css("fontStyle")==="italic"&&(f=$("<em></em>").get(0))),i(f),w=f},i=function(e){if(E!==n)return b||(b=w=a()),x=e,w.appendChild(e)},c=function(){if(x&&x.nodeType===1)return x.tagName.toLowerCase()},l=function(){if(b&&b.childNodes.length)return u.appendChild(b),b=w=null},a=function(){if(E===e)return $("<div></div>").get(0);if(E===t)return $("<li></li>").get(0)},h=function(e){var t;return t=$("<"+e+"></"+e+">").get(0),N.appendChild(t),t},N=u=$("<div></div>").get(0),C(f.childNodes),l(),N.innerHTML}}}(),WysiHat.Toolbar=function(){function e(e){this.editor=e,this.createToolbarElement(),this.addButtonSet()}return e.prototype.createToolbarElement=function(){return this.$el=$('<div class="editor_toolbar"></div>'),this.editor.$el.before(this.$el)},e.prototype.addButtonSet=function(){var e,t=this;return e=[{name:"bold",label:"<strong>Bold</strong>",hotkey:"meta+b ctrl+b"},{name:"italic",label:"<em>Italic</em>",hotkey:"meta+i ctrl+i"},{name:"underline",label:"<u>Underline</u>",hotkey:"meta+u ctrl+u"},{name:"unorderedList",label:"<i class='icon-list-ul'></i> Bullets"},{name:"orderedList",label:"<i class='icon-list-ol'></i> Numbers"}],$(e).each(function(e,n){return t.addButton(n)})},e.prototype.addButton=function(e){var t;return t=this.createButtonElement(e),this.observeButtonClick(t,this.buttonHandler(e.name)),this.observeStateChanges(t,this.buttonStateHandler(e.name))},e.prototype.createButtonElement=function(e){var t;return t=$('<a class="btn btn-mini" href="#">'+e.label+"</a>"),this.$el.append(t),e.hotkey&&this.editor.$el.bind("keydown",e.hotkey,function(e){return t.click(),e.preventDefault()}),t},e.prototype.buttonHandler=function(e){return function(t){return t.commands[e].call(t)}},e.prototype.observeButtonClick=function(e,t){var n=this;return $(e).click(function(){return t(n.editor.$el),$(document.activeElement).trigger("selection:change"),!1})},e.prototype.buttonStateHandler=function(e,t){return function(t){return t.states.queryCommandState.call(t,e)}},e.prototype.observeStateChanges=function(e,t){var n,r=this;return n=void 0,this.editor.$el.bind("selection:change",function(){var i;i=t(r.editor.$el);if(i!==n)return n=i,r.updateButtonState(e,i)})},e.prototype.updateButtonState=function(e,t){return t?$(e).addClass("active"):$(e).removeClass("active")},e}();